# 🤖 Replit 에이전트 명령어 - Google File Search 버전

## 🎯 전체 작업을 한 번에 요청 (추천!)

```
GOOGLE_FILE_SEARCH_GUIDE.md 파일을 읽고 그대로 따라서 Google File Search API 기반 RAG 챗봇을 완전히 구현해줘.

중요한 작업:

1. 데이터베이스 스키마 수정
   - manuals 테이블에 3개 필드 추가:
     * google_file_uri (TEXT)
     * google_file_state (TEXT)  
     * google_uploaded_at (TIMESTAMP)
   - 마이그레이션 실행

2. 패키지 설치
   npm install @google/generative-ai
   
3. 서버 파일 생성
   - server/services/fileSearchService.ts
   - server/routes/fileSearch.ts
   - DB import 경로 자동 수정

4. 서버 통합
   - server/index.ts에 라우트 추가

5. 클라이언트 컴포넌트
   - client/src/components/FileSearchChatbot.tsx 생성

6. 매뉴얼 라이브러리 페이지
   - FileSearchChatbot 컴포넌트로 교체

각 단계마다 완료되면 알려주고, 에러가 있으면 자동으로 수정해줘.
특히 DB import 경로는 프로젝트 구조에 맞게 자동으로 찾아서 수정해줘.
```

---

## 📝 단계별 진행 (세밀한 제어)

### 1단계: 데이터베이스 스키마 수정

```
다음 작업을 수행해줘:

1. db/schema.ts (또는 server/db/schema.ts) 파일 찾기

2. manuals 테이블에 다음 필드 추가:
   googleFileUri: text('google_file_uri'),
   googleFileState: text('google_file_state'),
   googleUploadedAt: timestamp('google_uploaded_at'),

3. 마이그레이션 파일 생성:
   ALTER TABLE manuals ADD COLUMN google_file_uri TEXT;
   ALTER TABLE manuals ADD COLUMN google_file_state TEXT;
   ALTER TABLE manuals ADD COLUMN google_uploaded_at TIMESTAMP;

4. 마이그레이션 실행

완료 후 "✅ 데이터베이스 스키마 업데이트 완료" 라고 알려줘.
```

### 2단계: 패키지 설치

```
다음 패키지를 설치해줘:

npm install @google/generative-ai

기존에 사용하지 않는 패키지 제거 (선택사항):
npm uninstall pdf-parse mammoth

완료 후 "✅ 패키지 설치 완료" 라고 알려줘.
```

### 3단계: File Search 서비스 생성

```
GOOGLE_FILE_SEARCH_GUIDE.md의 STEP 2를 참고해서:

1. server/services/fileSearchService.ts 파일 생성
   - GoogleAIFileManager를 사용한 파일 업로드
   - 데이터베이스 연동
   - File Search를 사용한 질의응답
   - DB import 경로를 프로젝트 구조에 맞게 자동 수정

완료 후 "✅ File Search 서비스 생성 완료" 라고 알려줘.
```

### 4단계: API 라우트 생성

```
GOOGLE_FILE_SEARCH_GUIDE.md의 STEP 3을 참고해서:

1. server/routes/fileSearch.ts 파일 생성
   - /api/file-search/setup (API 키 설정)
   - /api/file-search/upload-all (전체 업로드)
   - /api/file-search/ask (질문)
   - /api/file-search/files (파일 목록)
   - DELETE 엔드포인트들

완료 후 "✅ API 라우트 생성 완료" 라고 알려줘.
```

### 5단계: 서버 통합

```
server/index.ts에 다음 추가:

1. import fileSearchRoutes from './routes/fileSearch';
2. app.use(fileSearchRoutes);

기존 코드는 건드리지 말고 추가만 해줘.
완료 후 "✅ 서버 통합 완료" 라고 알려줘.
```

### 6단계: 클라이언트 컴포넌트 생성

```
GOOGLE_FILE_SEARCH_GUIDE.md의 STEP 5를 참고해서:

client/src/components/FileSearchChatbot.tsx 파일 생성
- "Google에 업로드" 버튼
- 업로드 진행 상태 표시
- File Search 기반 질의응답
- 업로드된 파일 목록 표시

완료 후 "✅ 클라이언트 컴포넌트 생성 완료" 라고 알려줘.
```

### 7단계: 매뉴얼 라이브러리 통합

```
매뉴얼 라이브러리 페이지를 찾아서:

기존 ChatbotModal 대신 FileSearchChatbot 사용:

1. import FileSearchChatbot from '../components/FileSearchChatbot';

2. <FileSearchChatbot
     isOpen={isChatOpen}
     onClose={() => setIsChatOpen(false)}
     apiKey={apiKey}
     onApiKeyRequired={() => {
       setIsChatOpen(false);
       setIsApiKeyModalOpen(true);
     }}
     userId={userId}
   />

완료 후 "✅ 페이지 통합 완료" 라고 알려줘.
```

### 8단계: 테스트

```
다음 테스트를 수행해줘:

1. npm run dev 실행
2. 콘솔 에러 확인
3. 매뉴얼 라이브러리 페이지 열기
4. 챗봇 아이콘 클릭 확인
5. "Google에 업로드" 버튼 확인

완료 후 현재 상태를 알려줘.
```

---

## 🔍 디버깅 명령어

### Google API 연결 테스트

```
다음 테스트 코드를 실행해서 Google API 연결을 확인해줘:

// server/test-google-api.ts
import { GoogleGenerativeAI, GoogleAIFileManager } from '@google/generative-ai';

const apiKey = 'YOUR_API_KEY'; // 실제 키 입력
const fileManager = new GoogleAIFileManager(apiKey);

async function testConnection() {
  try {
    console.log('✅ Google API 연결 성공');
  } catch (error) {
    console.error('❌ 연결 실패:', error);
  }
}

testConnection();

결과를 알려줘.
```

### 데이터베이스 스키마 확인

```
다음 쿼리로 스키마 변경을 확인해줘:

SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'manuals';

새로 추가된 3개 필드가 있는지 확인하고 알려줘.
```

### 파일 업로드 테스트

```
다음 코드로 단일 파일 업로드를 테스트해줘:

import { fileSearchService } from './services/fileSearchService';

async function testUpload() {
  await fileSearchService.initialize('YOUR_API_KEY');
  
  const result = await fileSearchService.uploadFile(
    'uploads/test.pdf',
    'test.pdf',
    'application/pdf'
  );
  
  console.log('업로드 결과:', result);
}

testUpload();

결과를 알려줘.
```

---

## 💡 문제 해결 명령어

### "GoogleAIFileManager is not a constructor" 오류

```
@google/generative-ai 패키지를 최신 버전으로 업데이트해줘:

npm uninstall @google/generative-ai
npm install @google/generative-ai@latest

그리고 import 구문을 확인해줘:
import { GoogleGenerativeAI, GoogleAIFileManager } from '@google/generative-ai';

결과를 알려줘.
```

### "File not found" 오류

```
다음 코드로 파일 경로를 디버깅해줘:

import fs from 'fs/promises';
import path from 'path';

const testPaths = [
  'uploads/manuals',
  'uploads',
  path.join(process.cwd(), 'uploads'),
];

for (const testPath of testPaths) {
  try {
    const files = await fs.readdir(testPath);
    console.log(`${testPath}:`, files.slice(0, 5));
  } catch (error) {
    console.log(`${testPath}: 경로 없음`);
  }
}

결과를 알려주고, 올바른 경로를 fileSearchService.ts에 반영해줘.
```

### 업로드 상태가 "PROCESSING"에서 멈춤

```
다음 코드로 파일 상태를 확인해줘:

import { GoogleAIFileManager } from '@google/generative-ai';

const fileManager = new GoogleAIFileManager('YOUR_API_KEY');

async function checkFile(fileName: string) {
  const file = await fileManager.getFile(fileName);
  console.log('파일 상태:', file.state);
  console.log('파일 정보:', file);
}

checkFile('files/YOUR_FILE_NAME');

상태가 FAILED면 에러 메시지를 알려줘.
```

---

## 🎯 기능 테스트 시나리오

### 시나리오 1: 전체 플로우

```
다음 순서대로 테스트하고 각 단계별 결과를 알려줘:

1. 서버 실행: npm run dev
2. 브라우저에서 매뉴얼 라이브러리 접속
3. 챗봇 아이콘 클릭
4. API 키 입력 (Gemini API 키)
5. "Google에 업로드" 버튼 클릭
6. 업로드 진행 상태 확인
7. 업로드 완료 메시지 확인
8. 질문 입력: "제품 보증 기간은?"
9. 답변 수신 확인
10. 검색된 파일 출처 확인

각 단계에서 문제가 있으면 멈추고 알려줘.
```

### 시나리오 2: 에러 핸들링

```
다음 에러 상황을 테스트하고 결과를 알려줘:

1. API 키 없이 업로드 시도
   - 예상: "API 키가 필요합니다" 메시지

2. 업로드 없이 질문 시도
   - 예상: "업로드된 매뉴얼이 없습니다" 메시지

3. 잘못된 API 키로 시도
   - 예상: "API 키가 유효하지 않습니다" 메시지

각 상황의 실제 결과를 알려줘.
```

---

## 📊 성능 비교

완료 후 다음 정보를 수집해서 알려줘:

```
1. 파일 업로드 시간:
   - 10페이지 PDF: ?초
   - 50페이지 PDF: ?초
   - 100페이지 PDF: ?분

2. 질문 응답 시간:
   - 평균: ?초

3. 메모리 사용량:
   - 기존 RAG: ?MB
   - Google File Search: ?MB

4. 코드 줄 수:
   - 기존: ~500줄
   - 신규: ~?줄
```

---

## 🎉 완료 체크리스트

모든 작업이 완료되면 다음을 체크하고 알려줘:

```
- [ ] 데이터베이스 스키마 업데이트 완료
- [ ] 패키지 설치 완료
- [ ] fileSearchService.ts 생성 완료
- [ ] fileSearch.ts 라우트 생성 완료
- [ ] 서버 통합 완료
- [ ] FileSearchChatbot.tsx 생성 완료
- [ ] 매뉴얼 라이브러리 통합 완료
- [ ] 서버 실행 성공 (에러 없음)
- [ ] 챗봇 UI 렌더링 확인
- [ ] Google 업로드 기능 동작 확인
- [ ] 질의응답 기능 동작 확인
- [ ] 파일 출처 표시 확인

모든 항목이 체크되면 "🎉 Google File Search 챗봇 구현 완료!" 라고 알려줘.
```

---

## 🚀 추가 최적화 (선택사항)

완료 후 다음 최적화를 적용할 수 있어:

```
1. 업로드 진행바 추가
   - 현재 파일/전체 파일 표시
   - 퍼센트 진행률

2. 파일 상태 모니터링
   - PROCESSING → ACTIVE 실시간 업데이트
   - 실패 파일 자동 재시도

3. 캐싱
   - 업로드된 파일 정보 로컬 스토리지 저장
   - 불필요한 API 호출 감소

4. 배치 처리
   - 여러 파일 동시 업로드
   - 병렬 처리로 속도 개선

원하는 최적화가 있으면 알려줘.
```

---

**이 명령어들을 순서대로 실행하면 Google File Search 기반 챗봇이 완성됩니다!** 🎉

### 핵심 장점 요약

✅ **간단한 구현** - 코드 줄 수 40% 감소  
✅ **자동 인덱싱** - 임베딩/청킹 자동 처리  
✅ **고급 검색** - Google의 최신 알고리즘  
✅ **확장성** - 파일 수 제한 없음  
✅ **비용 효율** - 무료 할당량으로 충분