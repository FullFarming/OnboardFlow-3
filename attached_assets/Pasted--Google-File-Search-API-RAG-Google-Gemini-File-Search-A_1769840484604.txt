# ğŸš€ Google File Search API ê¸°ë°˜ RAG ì±—ë´‡ ì™„ì „ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

Google Geminiì˜ **File Search API**ë¥¼ ì‚¬ìš©í•˜ì—¬ ë§¤ë‰´ì–¼ ì±—ë´‡ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

### ğŸ¯ ì™œ File Search APIë¥¼ ì‚¬ìš©í•˜ë‚˜ìš”?

| ê¸°ì¡´ RAG ë°©ì‹ | Google File Search |
|--------------|-------------------|
| âŒ ìˆ˜ë™ ì„ë² ë”© ìƒì„± | âœ… ìë™ ì„ë² ë”© |
| âŒ ì²­í¬ ë¶„í•  ì§ì ‘ êµ¬í˜„ | âœ… ìë™ ì²­í‚¹ |
| âŒ ë²¡í„° DB ê´€ë¦¬ í•„ìš” | âœ… Googleì´ ê´€ë¦¬ |
| âŒ ë³µì¡í•œ ê²€ìƒ‰ ë¡œì§ | âœ… ê°„ë‹¨í•œ API í˜¸ì¶œ |
| âš ï¸ ë©”ëª¨ë¦¬ ì‚¬ìš© ë§ìŒ | âœ… ì„œë²„ë¦¬ìŠ¤ |

### âœ¨ í•µì‹¬ ì¥ì 

1. **ê°„ë‹¨í•œ êµ¬í˜„**: íŒŒì¼ ì—…ë¡œë“œ â†’ ìë™ ì¸ë±ì‹±
2. **ê³ ê¸‰ ê²€ìƒ‰**: Googleì˜ ìµœì‹  ê²€ìƒ‰ ì•Œê³ ë¦¬ì¦˜
3. **ìë™ ê´€ë¦¬**: ì„ë² ë”©, ì²­í‚¹ ëª¨ë‘ ìë™
4. **í™•ì¥ì„±**: íŒŒì¼ ìˆ˜ ì œí•œ ì—†ìŒ
5. **ë¹„ìš© íš¨ìœ¨**: ë¬´ë£Œ í• ë‹¹ëŸ‰ ë‚´ ëŒ€ë¶€ë¶„ ì²˜ë¦¬ ê°€ëŠ¥

---

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ìˆ˜ì •

ë¨¼ì € ë§¤ë‰´ì–¼ í…Œì´ë¸”ì— Google File URIë¥¼ ì €ì¥í•  í•„ë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.

### ğŸ“„ `db/schema.ts` ìˆ˜ì • (ë˜ëŠ” `server/db/schema.ts`)

```typescript
import { pgTable, serial, text, timestamp, integer } from 'drizzle-orm/pg-core';

export const manuals = pgTable('manuals', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  filePath: text('file_path'),
  
  // ğŸ†• Google File API ê´€ë ¨ í•„ë“œ ì¶”ê°€
  googleFileUri: text('google_file_uri'),        // Googleì— ì—…ë¡œë“œëœ íŒŒì¼ URI
  googleFileState: text('google_file_state'),    // PROCESSING, ACTIVE, FAILED
  googleUploadedAt: timestamp('google_uploaded_at'),
  
  userId: integer('user_id'),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
});
```

### ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±

```typescript
// migrations/add_google_file_fields.sql
ALTER TABLE manuals ADD COLUMN google_file_uri TEXT;
ALTER TABLE manuals ADD COLUMN google_file_state TEXT;
ALTER TABLE manuals ADD COLUMN google_uploaded_at TIMESTAMP;
```

ë˜ëŠ” Drizzle ORM ë§ˆì´ê·¸ë ˆì´ì…˜:

```bash
npx drizzle-kit generate:pg
npx drizzle-kit push:pg
```

---

## ğŸ“¦ STEP 1: íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
npm install @google/generative-ai
```

**ê¸°ì¡´ íŒ¨í‚¤ì§€ ì œê±° ê°€ëŠ¥** (ì„ íƒì‚¬í•­):
```bash
npm uninstall pdf-parse mammoth
```

---

## ğŸ”§ STEP 2: File Search ì„œë¹„ìŠ¤ ìƒì„±

### ğŸ“„ `server/services/fileSearchService.ts` ìƒì„±

```typescript
import { GoogleGenerativeAI, GoogleAIFileManager } from '@google/generative-ai';
import { db } from '../db';
import { manuals } from '../db/schema';
import { eq } from 'drizzle-orm';
import path from 'path';
import fs from 'fs/promises';

interface UploadResult {
  manualId: number;
  filename: string;
  googleFileUri: string;
  state: string;
  success: boolean;
  error?: string;
}

interface SearchResult {
  answer: string;
  sources: Array<{
    filename: string;
    uri: string;
  }>;
}

export class FileSearchService {
  private genAI: GoogleGenerativeAI;
  private fileManager: GoogleAIFileManager;
  private chatModel: any;
  private isInitialized: boolean = false;

  constructor() {
    // ì´ˆê¸°ì—ëŠ” ë¹ˆ ìƒì„±ì
  }

  // API í‚¤ë¡œ ì´ˆê¸°í™”
  async initialize(apiKey: string): Promise<void> {
    this.genAI = new GoogleGenerativeAI(apiKey);
    this.fileManager = new GoogleAIFileManager(apiKey);
    
    // File Searchë¥¼ ì‚¬ìš©í•˜ëŠ” ëª¨ë¸ ì„¤ì •
    this.chatModel = this.genAI.getGenerativeModel({
      model: 'gemini-1.5-flash',
      generationConfig: {
        temperature: 0.7,
        maxOutputTokens: 2048,
      }
    });
    
    this.isInitialized = true;
  }

  // ë‹¨ì¼ íŒŒì¼ ì—…ë¡œë“œ
  async uploadFile(filePath: string, filename: string, mimeType?: string): Promise<{
    uri: string;
    state: string;
  }> {
    if (!this.isInitialized) {
      throw new Error('File Search ì„œë¹„ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }

    try {
      // MIME íƒ€ì… ìë™ ê°ì§€
      if (!mimeType) {
        const ext = path.extname(filename).toLowerCase();
        const mimeTypes: Record<string, string> = {
          '.pdf': 'application/pdf',
          '.docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
          '.doc': 'application/msword',
          '.txt': 'text/plain',
        };
        mimeType = mimeTypes[ext] || 'application/octet-stream';
      }

      console.log(`ğŸ“¤ Googleì— ì—…ë¡œë“œ ì¤‘: ${filename}`);

      const uploadResult = await this.fileManager.uploadFile(filePath, {
        mimeType: mimeType,
        displayName: filename,
      });

      console.log(`âœ… ì—…ë¡œë“œ ì™„ë£Œ: ${uploadResult.file.uri}`);
      console.log(`ğŸ“Š ìƒíƒœ: ${uploadResult.file.state}`);

      // íŒŒì¼ì´ ì²˜ë¦¬ë  ë•Œê¹Œì§€ ëŒ€ê¸°
      let file = uploadResult.file;
      while (file.state === 'PROCESSING') {
        await new Promise(resolve => setTimeout(resolve, 2000));
        file = await this.fileManager.getFile(file.name);
        console.log(`â³ ì²˜ë¦¬ ì¤‘... ìƒíƒœ: ${file.state}`);
      }

      if (file.state === 'FAILED') {
        throw new Error('íŒŒì¼ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }

      return {
        uri: file.uri,
        state: file.state
      };

    } catch (error) {
      console.error('íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
      throw error;
    }
  }

  // ë°ì´í„°ë² ì´ìŠ¤ì˜ ëª¨ë“  ë§¤ë‰´ì–¼ì„ Googleì— ì—…ë¡œë“œ
  async uploadAllManualsFromDB(userId?: number): Promise<{
    success: number;
    failed: number;
    skipped: number;
    total: number;
    details: UploadResult[];
  }> {
    if (!this.isInitialized) {
      throw new Error('File Search ì„œë¹„ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }

    try {
      // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë§¤ë‰´ì–¼ ê°€ì ¸ì˜¤ê¸°
      let query = db.select().from(manuals);
      if (userId) {
        query = query.where(eq(manuals.userId, userId));
      }

      const allManuals = await query;

      if (allManuals.length === 0) {
        return {
          success: 0,
          failed: 0,
          skipped: 0,
          total: 0,
          details: []
        };
      }

      console.log(`ğŸ“š ${allManuals.length}ê°œì˜ ë§¤ë‰´ì–¼ì„ Googleì— ì—…ë¡œë“œí•©ë‹ˆë‹¤...`);

      let successCount = 0;
      let failedCount = 0;
      let skippedCount = 0;
      const details: UploadResult[] = [];

      for (const manual of allManuals) {
        // ì´ë¯¸ ì—…ë¡œë“œëœ íŒŒì¼ì€ ìŠ¤í‚µ
        if (manual.googleFileUri && manual.googleFileState === 'ACTIVE') {
          console.log(`â­ï¸  ${manual.name} - ì´ë¯¸ ì—…ë¡œë“œë¨`);
          skippedCount++;
          details.push({
            manualId: manual.id,
            filename: manual.name,
            googleFileUri: manual.googleFileUri,
            state: manual.googleFileState,
            success: true
          });
          continue;
        }

        try {
          // íŒŒì¼ ê²½ë¡œ êµ¬ì„±
          const filePath = path.join(process.cwd(), 'uploads', manual.filePath || manual.name);

          // íŒŒì¼ ì¡´ì¬ í™•ì¸
          await fs.access(filePath);

          // Googleì— ì—…ë¡œë“œ
          const uploadResult = await this.uploadFile(filePath, manual.name);

          // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
          await db.update(manuals)
            .set({
              googleFileUri: uploadResult.uri,
              googleFileState: uploadResult.state,
              googleUploadedAt: new Date(),
            })
            .where(eq(manuals.id, manual.id));

          successCount++;
          details.push({
            manualId: manual.id,
            filename: manual.name,
            googleFileUri: uploadResult.uri,
            state: uploadResult.state,
            success: true
          });

          console.log(`âœ… ${manual.name} - ì—…ë¡œë“œ ì™„ë£Œ`);

          // API rate limit ë°©ì§€
          await new Promise(resolve => setTimeout(resolve, 1000));

        } catch (error) {
          console.error(`âŒ ${manual.name} - ì—…ë¡œë“œ ì‹¤íŒ¨:`, error);
          
          // ì‹¤íŒ¨ ìƒíƒœë¡œ ì—…ë°ì´íŠ¸
          await db.update(manuals)
            .set({
              googleFileState: 'FAILED',
            })
            .where(eq(manuals.id, manual.id));

          failedCount++;
          details.push({
            manualId: manual.id,
            filename: manual.name,
            googleFileUri: '',
            state: 'FAILED',
            success: false,
            error: error instanceof Error ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'
          });
        }
      }

      return {
        success: successCount,
        failed: failedCount,
        skipped: skippedCount,
        total: allManuals.length,
        details
      };

    } catch (error) {
      console.error('ì „ì²´ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
      throw new Error('ë§¤ë‰´ì–¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // File Searchë¥¼ ì‚¬ìš©í•œ ì§ˆì˜ì‘ë‹µ
  async searchAndAnswer(question: string, userId?: number): Promise<SearchResult> {
    if (!this.isInitialized) {
      throw new Error('File Search ì„œë¹„ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }

    try {
      // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í™œì„±í™”ëœ íŒŒì¼ URI ê°€ì ¸ì˜¤ê¸°
      let query = db.select().from(manuals)
        .where(eq(manuals.googleFileState, 'ACTIVE'));
      
      if (userId) {
        query = query.where(eq(manuals.userId, userId));
      }

      const activeManuals = await query;

      if (activeManuals.length === 0) {
        return {
          answer: 'ì—…ë¡œë“œëœ ë§¤ë‰´ì–¼ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € "ë§¤ë‰´ì–¼ ì—…ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”.',
          sources: []
        };
      }

      // File URI ì¶”ì¶œ
      const fileUris = activeManuals
        .filter(m => m.googleFileUri)
        .map(m => m.googleFileUri as string);

      console.log(`ğŸ” ${fileUris.length}ê°œ íŒŒì¼ì—ì„œ ê²€ìƒ‰ ì¤‘...`);

      // Grounding with Google Search ì‚¬ìš©
      const result = await this.chatModel.generateContent({
        contents: [
          {
            role: 'user',
            parts: [
              {
                text: `ë‹¹ì‹ ì€ ë§¤ë‰´ì–¼ ë¬¸ì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì§ˆë¬¸ì— ë‹µí•˜ëŠ” ì „ë¬¸ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.

ë‹¤ìŒ ì§ˆë¬¸ì— ëŒ€í•´ ì—…ë¡œë“œëœ ë§¤ë‰´ì–¼ íŒŒì¼ë“¤ì„ ì°¸ì¡°í•˜ì—¬ ì •í™•í•˜ê³  ìƒì„¸í•˜ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”:

ì§ˆë¬¸: ${question}

ë‹µë³€ ì‹œ ì£¼ì˜ì‚¬í•­:
- ë§¤ë‰´ì–¼ì— ìˆëŠ” ì •ë³´ë§Œ ì‚¬ìš©í•˜ì—¬ ë‹µë³€í•˜ì„¸ìš”
- ë§¤ë‰´ì–¼ì— ì—†ëŠ” ë‚´ìš©ì€ "í•´ë‹¹ ì •ë³´ëŠ” ì œê³µëœ ë§¤ë‰´ì–¼ì— ì—†ìŠµë‹ˆë‹¤"ë¼ê³  ë§í•˜ì„¸ìš”
- ê°€ëŠ¥í•œ í•œ êµ¬ì²´ì ì´ê³  ë‹¨ê³„ë³„ë¡œ ë‹µë³€í•˜ì„¸ìš”
- ë‹µë³€ì€ í•œêµ­ì–´ë¡œ í•´ì£¼ì„¸ìš”`
              }
            ]
          }
        ],
        // File Search í™œì„±í™”
        tools: [
          {
            googleSearchRetrieval: {}
          },
          {
            fileData: {
              fileUri: fileUris[0], // ì²« ë²ˆì§¸ íŒŒì¼
              mimeType: 'application/pdf'
            }
          }
        ]
      });

      const answer = result.response.text();

      // ì‚¬ìš©ëœ ì†ŒìŠ¤ ì¶”ì¶œ
      const sources = activeManuals.map(manual => ({
        filename: manual.name,
        uri: manual.googleFileUri as string
      }));

      return {
        answer,
        sources
      };

    } catch (error) {
      console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
      throw new Error('ë‹µë³€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡ ì¡°íšŒ
  async getUploadedFiles(userId?: number): Promise<Array<{
    filename: string;
    uri: string;
    state: string;
    uploadedAt: Date | null;
  }>> {
    try {
      let query = db.select().from(manuals)
        .where(eq(manuals.googleFileState, 'ACTIVE'));
      
      if (userId) {
        query = query.where(eq(manuals.userId, userId));
      }

      const uploadedManuals = await query;

      return uploadedManuals.map(manual => ({
        filename: manual.name,
        uri: manual.googleFileUri as string,
        state: manual.googleFileState as string,
        uploadedAt: manual.googleUploadedAt
      }));

    } catch (error) {
      console.error('íŒŒì¼ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
      return [];
    }
  }

  // íŠ¹ì • íŒŒì¼ ì‚­ì œ
  async deleteFile(manualId: number): Promise<void> {
    try {
      const manual = await db.select()
        .from(manuals)
        .where(eq(manuals.id, manualId))
        .limit(1);

      if (manual.length === 0) {
        throw new Error('ë§¤ë‰´ì–¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }

      const fileUri = manual[0].googleFileUri;
      if (fileUri) {
        // Googleì—ì„œ íŒŒì¼ ì‚­ì œ
        const fileName = fileUri.split('/').pop();
        if (fileName) {
          await this.fileManager.deleteFile(fileName);
        }
      }

      // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
      await db.update(manuals)
        .set({
          googleFileUri: null,
          googleFileState: null,
          googleUploadedAt: null,
        })
        .where(eq(manuals.id, manualId));

    } catch (error) {
      console.error('íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜:', error);
      throw error;
    }
  }

  // ëª¨ë“  íŒŒì¼ ì‚­ì œ
  async clearAll(userId?: number): Promise<void> {
    try {
      let query = db.select().from(manuals);
      if (userId) {
        query = query.where(eq(manuals.userId, userId));
      }

      const allManuals = await query;

      for (const manual of allManuals) {
        if (manual.googleFileUri) {
          try {
            const fileName = manual.googleFileUri.split('/').pop();
            if (fileName) {
              await this.fileManager.deleteFile(fileName);
            }
          } catch (error) {
            console.error(`íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: ${manual.name}`, error);
          }
        }
      }

      // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
      let updateQuery = db.update(manuals)
        .set({
          googleFileUri: null,
          googleFileState: null,
          googleUploadedAt: null,
        });
      
      if (userId) {
        updateQuery = updateQuery.where(eq(manuals.userId, userId));
      }

      await updateQuery;

    } catch (error) {
      console.error('ì „ì²´ ì‚­ì œ ì˜¤ë¥˜:', error);
      throw error;
    }
  }
}

// ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤
export const fileSearchService = new FileSearchService();
```

---

## ğŸ›£ï¸ STEP 3: API ë¼ìš°íŠ¸ ìƒì„±

### ğŸ“„ `server/routes/fileSearch.ts` ìƒì„±

```typescript
import express, { Request, Response } from 'express';
import { fileSearchService } from '../services/fileSearchService';

const router = express.Router();

// API í‚¤ ì„¤ì •
router.post('/api/file-search/setup', async (req: Request, res: Response) => {
  try {
    const { apiKey } = req.body;
    
    if (!apiKey) {
      return res.status(400).json({ error: 'API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    await fileSearchService.initialize(apiKey);
    res.json({ message: 'File Search ì„œë¹„ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.' });
  } catch (error) {
    console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ëª¨ë“  ë§¤ë‰´ì–¼ì„ Googleì— ì—…ë¡œë“œ
router.post('/api/file-search/upload-all', async (req: Request, res: Response) => {
  try {
    const { userId } = req.body;
    
    console.log('ğŸ“š ë§¤ë‰´ì–¼ ì—…ë¡œë“œ ì‹œì‘...');
    
    const result = await fileSearchService.uploadAllManualsFromDB(userId);

    res.json({
      message: 'ë§¤ë‰´ì–¼ ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
      result: {
        success: result.success,
        failed: result.failed,
        skipped: result.skipped,
        total: result.total
      },
      details: result.details
    });
  } catch (error) {
    console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
    res.status(500).json({ 
      error: error instanceof Error ? error.message : 'ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' 
    });
  }
});

// ì§ˆë¬¸í•˜ê¸°
router.post('/api/file-search/ask', async (req: Request, res: Response) => {
  try {
    const { question, userId } = req.body;

    if (!question) {
      return res.status(400).json({ error: 'ì§ˆë¬¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    const result = await fileSearchService.searchAndAnswer(question, userId);

    res.json({
      answer: result.answer,
      sources: result.sources
    });
  } catch (error) {
    console.error('ì§ˆë¬¸ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    res.status(500).json({ 
      error: error instanceof Error ? error.message : 'ë‹µë³€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' 
    });
  }
});

// ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡ ì¡°íšŒ
router.get('/api/file-search/files', async (req: Request, res: Response) => {
  try {
    const { userId } = req.query;
    const files = await fileSearchService.getUploadedFiles(
      userId ? parseInt(userId as string) : undefined
    );
    res.json({ files });
  } catch (error) {
    console.error('íŒŒì¼ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'íŒŒì¼ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
  }
});

// íŠ¹ì • íŒŒì¼ ì‚­ì œ
router.delete('/api/file-search/files/:manualId', async (req: Request, res: Response) => {
  try {
    const { manualId } = req.params;
    await fileSearchService.deleteFile(parseInt(manualId));
    res.json({ message: 'íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' });
  } catch (error) {
    console.error('íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ëª¨ë“  íŒŒì¼ ì‚­ì œ
router.delete('/api/file-search/files', async (req: Request, res: Response) => {
  try {
    const { userId } = req.body;
    await fileSearchService.clearAll(userId);
    res.json({ message: 'ëª¨ë“  íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' });
  } catch (error) {
    console.error('ì „ì²´ ì‚­ì œ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

export default router;
```

---

## ğŸ”— STEP 4: ì„œë²„ì— ë¼ìš°íŠ¸ ì¶”ê°€

### ğŸ“ `server/index.ts` ìˆ˜ì •

```typescript
// ê¸°ì¡´ imports...
import fileSearchRoutes from './routes/fileSearch';

// ê¸°ì¡´ ë¯¸ë“¤ì›¨ì–´...
app.use(express.json());

// File Search ë¼ìš°íŠ¸ ì¶”ê°€
app.use(fileSearchRoutes);

// ë‚˜ë¨¸ì§€ ì½”ë“œ...
```

---

## ğŸ¨ STEP 5: í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ ìˆ˜ì •

### ğŸ“„ `client/src/components/FileSearchChatbot.tsx` ìƒì„±

```typescript
import React, { useState, useEffect, useRef } from 'react';
import { X, Send, MessageCircle, Loader2, CloudUpload, FileText, CheckCircle } from 'lucide-react';

interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  sources?: Array<{ filename: string; uri: string }>;
  timestamp: Date;
}

interface UploadResult {
  success: number;
  failed: number;
  skipped: number;
  total: number;
}

interface FileSearchChatbotProps {
  isOpen: boolean;
  onClose: () => void;
  apiKey: string;
  onApiKeyRequired: () => void;
  userId?: number;
}

export default function FileSearchChatbot({ 
  isOpen, 
  onClose, 
  apiKey, 
  onApiKeyRequired, 
  userId 
}: FileSearchChatbotProps) {
  const [messages, setMessages] = useState<Message[]>([]);
  const [inputMessage, setInputMessage] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [uploadedFiles, setUploadedFiles] = useState<Array<{ 
    filename: string; 
    uri: string; 
    state: string; 
  }>>([]);
  
  // ì—…ë¡œë“œ ìƒíƒœ
  const [isUploading, setIsUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState<UploadResult | null>(null);
  const [showUploadResult, setShowUploadResult] = useState(false);
  
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLTextAreaElement>(null);

  useEffect(() => {
    if (isOpen && inputRef.current) {
      inputRef.current.focus();
    }
  }, [isOpen]);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  useEffect(() => {
    if (isOpen && apiKey) {
      loadUploadedFiles();
    }
  }, [isOpen, apiKey]);

  const loadUploadedFiles = async () => {
    try {
      const params = userId ? `?userId=${userId}` : '';
      const response = await fetch(`/api/file-search/files${params}`);
      const data = await response.json();
      if (response.ok) {
        setUploadedFiles(data.files || []);
      }
    } catch (error) {
      console.error('íŒŒì¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
    }
  };

  // Googleì— ë§¤ë‰´ì–¼ ì—…ë¡œë“œ
  const handleUploadToGoogle = async () => {
    if (!apiKey) {
      onApiKeyRequired();
      return;
    }

    setIsUploading(true);
    setShowUploadResult(false);
    
    try {
      const response = await fetch('/api/file-search/upload-all', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId })
      });

      const data = await response.json();
      
      if (response.ok) {
        setUploadProgress(data.result);
        setShowUploadResult(true);
        await loadUploadedFiles();
        
        if (data.result.success > 0) {
          addMessage('assistant', 
            `âœ… ${data.result.success}ê°œì˜ ë§¤ë‰´ì–¼ì´ Googleì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\n` +
            `ì´ì œ ê³ ê¸‰ ê²€ìƒ‰ ê¸°ëŠ¥ìœ¼ë¡œ ì§ˆë¬¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
          );
        }
        
        if (data.result.failed > 0) {
          addMessage('assistant', 
            `âš ï¸ ${data.result.failed}ê°œì˜ ë§¤ë‰´ì–¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`
          );
        }
      } else {
        addMessage('assistant', `âŒ ì˜¤ë¥˜: ${data.error}`);
      }
    } catch (error) {
      console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
      addMessage('assistant', 'âŒ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setIsUploading(false);
    }
  };

  const addMessage = (role: 'user' | 'assistant', content: string, sources?: Array<{ filename: string; uri: string }>) => {
    const newMessage: Message = {
      id: Date.now().toString(),
      role,
      content,
      sources,
      timestamp: new Date()
    };
    setMessages(prev => [...prev, newMessage]);
  };

  const handleSendMessage = async () => {
    if (!inputMessage.trim() || isLoading) return;

    if (!apiKey) {
      onApiKeyRequired();
      return;
    }

    const question = inputMessage.trim();
    setInputMessage('');
    addMessage('user', question);
    
    setIsLoading(true);
    try {
      const response = await fetch('/api/file-search/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, userId })
      });

      const data = await response.json();
      
      if (response.ok) {
        addMessage('assistant', data.answer, data.sources);
      } else {
        addMessage('assistant', `âŒ ì˜¤ë¥˜: ${data.error}`);
      }
    } catch (error) {
      console.error('ì§ˆë¬¸ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
      addMessage('assistant', 'âŒ ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setIsLoading(false);
    }
  };

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl h-[600px] flex flex-col">
        {/* í—¤ë” */}
        <div className="bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between">
          <div className="flex items-center space-x-3">
            <MessageCircle className="w-6 h-6" />
            <div>
              <h2 className="text-lg font-semibold">ë§¤ë‰´ì–¼ ì±—ë´‡</h2>
              <p className="text-xs text-blue-100">
                {uploadedFiles.length > 0 
                  ? `${uploadedFiles.length}ê°œ ë§¤ë‰´ì–¼ ì—…ë¡œë“œë¨ (Google File Search)` 
                  : 'Google File Search ê¸°ë°˜'}
              </p>
            </div>
          </div>
          <button
            onClick={onClose}
            className="hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition"
          >
            <X className="w-5 h-5" />
          </button>
        </div>

        {/* ì—…ë¡œë“œ ì•Œë¦¼ ë°°ë„ˆ */}
        {uploadedFiles.length === 0 && !isUploading && (
          <div className="bg-blue-50 border-b border-blue-200 px-6 py-4">
            <div className="flex items-start space-x-3">
              <CloudUpload className="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" />
              <div className="flex-1">
                <p className="text-sm text-blue-900 font-medium">
                  ë§¤ë‰´ì–¼ì„ Googleì— ì—…ë¡œë“œí•˜ì„¸ìš”
                </p>
                <p className="text-xs text-blue-700 mt-1">
                  ìë™ ì¸ë±ì‹± ë° ê³ ê¸‰ ê²€ìƒ‰ ê¸°ëŠ¥ ì œê³µ
                </p>
              </div>
              <button
                onClick={handleUploadToGoogle}
                className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm font-medium whitespace-nowrap"
              >
                Googleì— ì—…ë¡œë“œ
              </button>
            </div>
          </div>
        )}

        {/* ì—…ë¡œë“œ ì§„í–‰ ì¤‘ */}
        {isUploading && (
          <div className="bg-amber-50 border-b border-amber-200 px-6 py-4">
            <div className="flex items-center space-x-3">
              <Loader2 className="w-5 h-5 text-amber-600 animate-spin flex-shrink-0" />
              <div>
                <p className="text-sm text-amber-900 font-medium">
                  Googleì— ì—…ë¡œë“œ ì¤‘...
                </p>
                <p className="text-xs text-amber-700 mt-1">
                  íŒŒì¼ ìˆ˜ì— ë”°ë¼ 1-5ë¶„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                </p>
              </div>
            </div>
          </div>
        )}

        {/* ì—…ë¡œë“œ ê²°ê³¼ */}
        {showUploadResult && uploadProgress && (
          <div className="bg-green-50 border-b border-green-200 px-6 py-4">
            <div className="flex items-start justify-between">
              <div className="flex items-start space-x-3 flex-1">
                <CheckCircle className="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" />
                <div>
                  <p className="text-sm text-green-900 font-medium">
                    ì—…ë¡œë“œ ì™„ë£Œ!
                  </p>
                  <p className="text-xs text-green-700 mt-1">
                    ì„±ê³µ: {uploadProgress.success}ê°œ â€¢ 
                    ì‹¤íŒ¨: {uploadProgress.failed}ê°œ â€¢ 
                    ìŠ¤í‚µ: {uploadProgress.skipped}ê°œ
                  </p>
                </div>
              </div>
              <button
                onClick={() => setShowUploadResult(false)}
                className="hover:bg-green-100 rounded p-1 transition"
              >
                <X className="w-4 h-4 text-green-600" />
              </button>
            </div>
          </div>
        )}

        {/* ë©”ì‹œì§€ ì˜ì—­ */}
        <div className="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50">
          {messages.length === 0 ? (
            <div className="h-full flex items-center justify-center">
              <div className="text-center max-w-md">
                <CloudUpload className="w-16 h-16 mx-auto mb-4 text-gray-300" />
                <h3 className="text-lg font-semibold text-gray-700 mb-2">
                  Google File Searchë¡œ ë” ì •í™•í•œ ë‹µë³€
                </h3>
                <p className="text-sm text-gray-500 mb-4">
                  Googleì˜ ê³ ê¸‰ ê²€ìƒ‰ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ë§¤ë‰´ì–¼ì„ ë¶„ì„í•©ë‹ˆë‹¤
                </p>
                
                {uploadedFiles.length > 0 && (
                  <div className="mt-6 space-y-1">
                    <p className="text-xs text-gray-400">ì—…ë¡œë“œëœ íŒŒì¼:</p>
                    {uploadedFiles.slice(0, 3).map((file, idx) => (
                      <div key={idx} className="text-xs text-gray-600 flex items-center justify-center">
                        <FileText className="w-3 h-3 mr-1" />
                        {file.filename}
                      </div>
                    ))}
                    {uploadedFiles.length > 3 && (
                      <p className="text-xs text-gray-400 mt-1">
                        ì™¸ {uploadedFiles.length - 3}ê°œ
                      </p>
                    )}
                  </div>
                )}
              </div>
            </div>
          ) : (
            messages.map((message) => (
              <div
                key={message.id}
                className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}
              >
                <div
                  className={`max-w-[80%] rounded-2xl px-4 py-3 ${
                    message.role === 'user'
                      ? 'bg-blue-600 text-white'
                      : 'bg-white shadow-sm border border-gray-200'
                  }`}
                >
                  <p className="whitespace-pre-wrap text-sm">{message.content}</p>
                  
                  {message.sources && message.sources.length > 0 && (
                    <div className="mt-2 pt-2 border-t border-gray-200">
                      <p className="text-xs text-gray-500 mb-1">ğŸ” ê²€ìƒ‰ëœ íŒŒì¼:</p>
                      <div className="space-y-1">
                        {message.sources.map((source, idx) => (
                          <div key={idx} className="text-xs text-gray-600 flex items-start">
                            <span className="mr-1">â€¢</span>
                            <span>{source.filename}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            ))
          )}
          {isLoading && (
            <div className="flex justify-start">
              <div className="bg-white shadow-sm border border-gray-200 rounded-2xl px-4 py-3 flex items-center space-x-2">
                <Loader2 className="w-4 h-4 animate-spin text-blue-600" />
                <span className="text-sm text-gray-600">Googleì—ì„œ ê²€ìƒ‰ ì¤‘...</span>
              </div>
            </div>
          )}
          <div ref={messagesEndRef} />
        </div>

        {/* ì…ë ¥ ì˜ì—­ */}
        <div className="border-t bg-white p-4 rounded-b-2xl">
          {uploadedFiles.length > 0 && !isUploading && (
            <div className="flex justify-end mb-2">
              <button
                onClick={handleUploadToGoogle}
                className="text-xs text-blue-600 hover:text-blue-700 font-medium flex items-center space-x-1"
              >
                <CloudUpload className="w-3 h-3" />
                <span>ë§¤ë‰´ì–¼ ì¬ì—…ë¡œë“œ</span>
              </button>
            </div>
          )}
          
          <div className="flex space-x-2">
            <textarea
              ref={inputRef}
              value={inputMessage}
              onChange={(e) => setInputMessage(e.target.value)}
              onKeyPress={handleKeyPress}
              placeholder={
                uploadedFiles.length > 0 
                  ? "ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                  : "ë¨¼ì € 'Googleì— ì—…ë¡œë“œ' ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”"
              }
              rows={1}
              className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-sm"
              disabled={isLoading || uploadedFiles.length === 0 || isUploading}
            />
            <button
              onClick={handleSendMessage}
              disabled={isLoading || !inputMessage.trim() || uploadedFiles.length === 0 || isUploading}
              className="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition flex items-center"
            >
              <Send className="w-5 h-5" />
            </button>
          </div>
          <p className="text-xs text-gray-500 mt-2 text-center">
            Shift + Enterë¡œ ì¤„ë°”ê¿ˆ â€¢ Enterë¡œ ì „ì†¡
          </p>
        </div>
      </div>
    </div>
  );
}
```

---

## ğŸ”Œ STEP 6: ë§¤ë‰´ì–¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ í˜ì´ì§€ í†µí•©

ê¸°ì¡´ ChatbotModal ëŒ€ì‹  FileSearchChatbot ì‚¬ìš©:

```typescript
import FileSearchChatbot from '../components/FileSearchChatbot';

// ...

<FileSearchChatbot
  isOpen={isChatOpen}
  onClose={() => setIsChatOpen(false)}
  apiKey={apiKey}
  onApiKeyRequired={() => {
    setIsChatOpen(false);
    setIsApiKeyModalOpen(true);
  }}
  userId={userId}
/>
```

---

## ğŸ“Š ë¹„êµí‘œ

| ê¸°ëŠ¥ | ê¸°ì¡´ RAG | Google File Search |
|------|---------|-------------------|
| êµ¬í˜„ ë³µì¡ë„ | ë†’ìŒ | ë‚®ìŒ |
| ì½”ë“œ ì¤„ ìˆ˜ | ~500 ì¤„ | ~300 ì¤„ |
| ì„ë² ë”© ìƒì„± | ìˆ˜ë™ | ìë™ |
| ì²­í‚¹ | ìˆ˜ë™ | ìë™ |
| ê²€ìƒ‰ í’ˆì§ˆ | ë³´í†µ | ìš°ìˆ˜ |
| ë©”ëª¨ë¦¬ ì‚¬ìš© | ë§ìŒ | ì ìŒ |
| í™•ì¥ì„± | ì œí•œì  | ìš°ìˆ˜ |
| ìœ ì§€ë³´ìˆ˜ | ì–´ë ¤ì›€ | ì‰¬ì›€ |

---

## ğŸš€ ì‹¤í–‰ ìˆœì„œ

1. âœ… ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
2. âœ… ì„œë²„ ì‹¤í–‰
3. âœ… ì±—ë´‡ ì—´ê¸°
4. âœ… API í‚¤ ì…ë ¥
5. âœ… "Googleì— ì—…ë¡œë“œ" í´ë¦­
6. âœ… ì—…ë¡œë“œ ì™„ë£Œ ëŒ€ê¸°
7. âœ… ì§ˆë¬¸í•˜ê¸°!

---

**ì´ì œ Googleì˜ ê°•ë ¥í•œ ê²€ìƒ‰ ê¸°ëŠ¥ìœ¼ë¡œ ë” ì •í™•í•œ ë‹µë³€ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!** ğŸ‰